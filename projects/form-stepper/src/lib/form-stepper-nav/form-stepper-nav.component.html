<nav *ngIf="state$ | async as state" class="form-stepper-nav-sections">
  <div
    *ngIf="state.onboardingInfo"
    class="form-stepper-nav-section"
    [class.form-stepper-nav-section--valid]="state.maxStepIndexViewed >= 0"
    [class.form-stepper-nav-section--current]="state.stepIndex === -1"
  >
    <span class="form-stepper-nav-section__bullet"></span>

    <button
      type="button"
      tabindex="-1"
      class="form-stepper-nav-section__btn"
      (click)="navigateByStepIndex($event, state.onboardingInfo.index)"
    >
      <span class="form-stepper-nav-section__icon">
        <form-stepper-icon [icon]="state.maxStepIndexViewed >= 0 ? 'check' : 'edit'"></form-stepper-icon>
      </span>

      {{ state.onboardingInfo.title }}
    </button>
  </div>

  <div
    *ngFor="let section of state.nav; let sectionIndex = index; let isLastSectionIndex = last"
    class="form-stepper-nav-section"
    [class.form-stepper-nav-section--valid]="section.offset <= state.maxStepIndexViewed && section.control.valid"
    [class.form-stepper-nav-section--current]="state.sectionIndex === sectionIndex"
    [class.form-stepper-nav-section--last]="!state.summaryInfo && isLastSectionIndex"
  >
    <span class="form-stepper-nav-section__bullet"></span>

    <button
      type="button"
      tabindex="-1"
      class="form-stepper-nav-section__btn"
      [disabled]="section.offset > state.maxStepIndexViewed && section.steps[0].control.pristine"
      (click)="navigateByStepIndex($event, section.offset)"
    >
      <span
        *ngIf="state.sectionProgression && state.sectionIndex === sectionIndex"
        class="form-stepper-nav-section__progression"
      >
        {{ state.sectionProgression.count }}/{{ state.sectionProgression.total }}
      </span>

      <span class="form-stepper-nav-section__icon">
        <form-stepper-icon
          [icon]="section.offset <= state.maxStepIndexViewed && section.control.valid ? 'check' : 'edit'"
        ></form-stepper-icon>
      </span>

      {{ section.title }}
    </button>

    <ng-container *ngIf="state.sectionIndex === sectionIndex">
      <div *ngIf="section.steps.length >= 2" class="form-stepper-nav-steps" @smoothHeight>
        <div
          *ngFor="let step of section.steps; let relativeStepIndex = index"
          class="form-stepper-nav-step"
          [class.form-stepper-nav-step--valid]="
            section.offset + relativeStepIndex <= state.maxStepIndexViewed && step.control.valid
          "
          [class.form-stepper-nav-step--current]="state.stepIndex === section.offset + relativeStepIndex"
        >
          <form-stepper-icon icon="checkCircle" class="form-stepper-nav-step__icon"></form-stepper-icon>

          <button
            type="button"
            tabindex="-1"
            class="form-stepper-nav-step__btn"
            [disabled]="section.offset + relativeStepIndex > state.maxStepIndexViewed && step.control.pristine"
            (click)="navigateByStepIndex($event, section.offset + relativeStepIndex)"
          >
            {{ step.title }}
          </button>
        </div>
      </div>
    </ng-container>
  </div>

  <div
    *ngIf="state.summaryInfo"
    class="form-stepper-nav-section form-stepper-nav-section--last"
    [class.form-stepper-nav-section--valid]="state.allStepsViewed"
    [class.form-stepper-nav-section--current]="state.stepIndex === state.lastStepIndex"
  >
    <span class="form-stepper-nav-section__bullet"></span>

    <button
      type="button"
      tabindex="-1"
      class="form-stepper-nav-section__btn"
      [disabled]="!state.allStepsViewed"
      (click)="navigateByStepIndex($event, state.summaryInfo.index)"
    >
      <span class="form-stepper-nav-section__icon">
        <form-stepper-icon [icon]="state.allStepsViewed ? 'check' : 'edit'"></form-stepper-icon>
      </span>

      {{ state.summaryInfo.title }}
    </button>
  </div>
</nav>
