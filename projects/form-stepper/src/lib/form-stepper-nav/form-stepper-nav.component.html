<nav *ngIf="state$ | async as state" class="sections">
  <div
    *ngIf="state.onboardingInfo"
    class="section"
    [class.section--valid]="state.maxStepIndexViewed >= 0"
    [class.section--current]="state.stepIndex === -1"
  >
    <span class="section__bullet"></span>

    <button
      type="button"
      tabindex="-1"
      class="section__btn"
      (click)="navigateByStepIndex($event, state.onboardingInfo.index)"
    >
      <span class="section__icon">
        <form-stepper-icon [icon]="state.maxStepIndexViewed >= 0 ? 'valid' : 'invalid'"></form-stepper-icon>
      </span>

      {{ state.onboardingInfo.title }}
    </button>
  </div>

  <div
    *ngFor="let section of state.nav; let sectionIndex = index; let isLastSectionIndex = last"
    class="section"
    [class.section--valid]="section.offset <= state.maxStepIndexViewed && section.control.valid"
    [class.section--current]="state.sectionIndex === sectionIndex"
    [class.section--last]="!state.summaryInfo && isLastSectionIndex"
  >
    <span class="section__bullet"></span>

    <button
      type="button"
      tabindex="-1"
      class="section__btn"
      [disabled]="section.offset > state.maxStepIndexViewed && section.steps[0].control.pristine"
      (click)="navigateByStepIndex($event, section.offset)"
    >
      <span *ngIf="state.sectionProgression && state.sectionIndex === sectionIndex" class="section__progression">
        {{ state.sectionProgression.count }}/{{ state.sectionProgression.total }}
      </span>

      <span class="section__icon">
        <form-stepper-icon
          [icon]="section.offset <= state.maxStepIndexViewed && section.control.valid ? 'valid' : 'invalid'"
        ></form-stepper-icon>
      </span>

      {{ section.title }}
    </button>

    <ng-container *ngIf="state.sectionIndex === sectionIndex">
      <div *ngIf="section.steps.length >= 2" class="steps" @smoothHeight>
        <div
          *ngFor="let step of section.steps; let relativeStepIndex = index"
          class="step"
          [class.step--valid]="section.offset + relativeStepIndex <= state.maxStepIndexViewed && step.control.valid"
          [class.step--current]="state.stepIndex === section.offset + relativeStepIndex"
        >
          <button
            type="button"
            tabindex="-1"
            class="step__btn"
            [disabled]="section.offset + relativeStepIndex > state.maxStepIndexViewed && step.control.pristine"
            (click)="navigateByStepIndex($event, section.offset + relativeStepIndex)"
          >
            {{ step.title }}
          </button>
        </div>
      </div>
    </ng-container>
  </div>

  <div
    *ngIf="state.summaryInfo"
    class="section section--last"
    [class.section--valid]="state.allStepsViewed"
    [class.section--current]="state.stepIndex === state.lastStepIndex"
  >
    <span class="section__bullet"></span>

    <button
      type="button"
      tabindex="-1"
      class="section__btn"
      [disabled]="!state.allStepsViewed"
      (click)="navigateByStepIndex($event, state.summaryInfo.index)"
    >
      <span class="section__icon">
        <form-stepper-icon [icon]="state.allStepsViewed ? 'valid' : 'invalid'"></form-stepper-icon>
      </span>

      {{ state.summaryInfo.title }}
    </button>
  </div>
</nav>
